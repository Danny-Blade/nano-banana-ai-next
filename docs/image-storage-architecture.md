# 图片存储架构设计

> 本地缓存优先 + R2 云端存储的混合架构

## 概述

本架构实现了一个高效的图片存储和同步系统，优先使用本地 IndexedDB 缓存，同时将图片持久化存储在 Cloudflare R2 中，实现跨设备同步。

## 架构图

```
┌────────────────────────────────────────────────────────────────��┐
│                         客户端 (Browser)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐     ┌──────────────────┐     ┌──────────────┐ │
│  │  Dashboard  │────▶│  useImageHistory │────▶│ ImageHistory │ │
│  └──────┬──────┘     └────────┬─────────┘     └──────┬───────┘ │
│         │                     │                      │         │
│         ▼                     ▼                      ▼         │
��  ┌─────────────┐     ┌──────────────────┐     ┌──────────────┐ │
│  │ useImageSync│     │useLocalImageCache│     │  显示图片    │ │
│  └──────┬──────┘     └────────┬─────────┘     └──────┬───────┘ │
│         │                     │                      │         │
│         │              ┌──────▼───────┐              │         │
│         │              │  IndexedDB   │◀─────────────┘         │
│         │              │ (本地缓存)   │     (缓存优先)          │
│         │              └──────────────┘                        │
│         │                                                      │
└─────────┼──────────────────────────────────────────────────────┘
          │
          ▼ API 请求
┌────────────────────────────────────────────────────────────────��┐
│                    服务端 (Cloudflare Workers)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────────┐  │
│  │ /api/image/    │  │ /api/history/  │  │ /api/r2/image/   │  │
│  │   generate     │  │     sync       │  │    [key]         │  │
│  └───────┬────────┘  └───────┬────────┘  └────────┬─────────┘  │
│          │                   │                    │            │
│          ▼                   ▼                    ▼            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                      src/lib/r2.ts                        │  │
│  │         (uploadToR2 / getFromR2 / deleteFromR2)           │  │
│  └──────────────────────────┬───────────────────────────────┘  │
│                             │                                  │
└─────────────────────────────┼──────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Cloudflare R2 存储                          │
│                   (nano-banana-images bucket)                   │
│                                                                 │
│   存储格式: images/{userId}/{timestamp}_{hash}.{ext}            │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流程

### 1. 图片生成流程

```
用户提交生成请求
        │
        ▼
┌───────────────────┐
│ /api/image/generate│
│   调用 AI API      │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  获取图片数据      │
│ (base64/URL)      │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  上传到 R2        │──────▶ R2 存储
│  获取 r2Key       │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  保存到 D1 数据库  │──────▶ D1 数据库
│ (含 r2_key 字段)  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  返回给客户端      │
│ (含 r2Url)        │
└───────────────────┘
```

### 2. 图片显示流程 (缓存优先)

```
请求显示图片
        │
        ▼
┌───────────────────┐
│ 检查 IndexedDB    │
│ 是否有本地缓存?    │
└─────────┬─────────┘
          │
    ┌─────┴─────┐
    │           │
   有           无
    │           │
    ▼           ▼
┌───────┐  ┌────────────┐
│直接显示│  │从 R2 URL   │
│(最快) │  │ 拉取图片   │
└───────┘  └─────┬──────┘
                 │
                 ▼
           ┌────────────┐
           │ 显示图片   │
           │ + 存入缓存 │
           └────────────┘
```

### 3. 跨设备同步流程

```
新设备登录
        │
        ▼
┌───────────────────┐
│ 检测本地历史为空   │
│ 或版本号不一致     │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 显示同步提示      │
│ (SyncIndicator)   │
└─────────┬─────────┘
          │ 用户确认
          ▼
┌───────────────────┐
│ 调用 /api/history │
│ /sync 获取历史    │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 批量下载图片到    │
│ IndexedDB 缓存    │
└─────────┬──���──────┘
          │
          ▼
┌───────────────────┐
│  同步完成         │
│  本地可离线访问    │
└───────────────────┘
```

## 文件结构

```
src/
├── lib/
│   └── r2.ts                      # R2 操作封装
│       ├── uploadToR2()           # 上传图片
│       ├── getFromR2()            # 获取图片
│       └── deleteFromR2()         # 删除图片
│
├── app/api/
│   ├── image/generate/route.ts    # 图片生成 (修改: 自动上传 R2)
│   ├── r2/image/[key]/route.ts    # R2 图片代理
│   └── history/sync/route.ts      # 历史同步 API
│
├── hooks/
│   ├── useImageHistory.ts         # 历史状态管理 (修改: 新增字段)
│   ├── useLocalImageCache.ts      # 本地 IndexedDB 缓存
│   ��── useImageSync.ts            # 同步逻辑
│
└── components/
    ├── Dashboard.tsx              # 主控面板 (修改: 集成同步)
    ├── ImageHistory.tsx           # 历史显示
    ├── SyncIndicator.tsx          # 同步进度 UI
    └── SyncIndicator.module.css
```

## 数据结构

### ImageHistoryItem (扩展)

```typescript
interface ImageHistoryItem {
  id: string;
  prompt: string;
  imageUrl: string;       // 原始 URL (可能过期)
  r2Key?: string;         // R2 存储 key
  r2Url?: string;         // R2 代理 URL (持久)
  localCached?: boolean;  // 是否已本地缓存
  timestamp: number;
  model: string;
  // ... 其他字段
}
```

### IndexedDB 结构

```
Database: nano-banana-images
└── Store: image-cache
    ├── key: r2Key (string)
    └── value: {
          blob: Blob,
          timestamp: number,
          size: number
        }
```

## 配置说明

### wrangler.jsonc

```jsonc
{
  "r2_buckets": [
    {
      "binding": "R2_BUCKET",
      "bucket_name": "nano-banana-images"
    }
  ]
}
```

### 环境变量

| 变量名 | 说明 | 必需 |
|--------|------|------|
| `R2_PUBLIC_DOMAIN` | R2 公开域名 (可选，用于直接访问) | 否 |

## 部署步骤

### 1. 创建 R2 存储桶

```bash
wrangler r2 bucket create nano-banana-images
```

### 2. 运行数据库迁移

如果需要添加 `r2_key` 字段到现有表：

```bash
yarn d1:migrate:local   # 本地
yarn d1:migrate:remote  # 生产
```

### 3. 部署

```bash
yarn build
yarn deploy
```

## 性能优化

### 缓存策略

1. **本地优先**: IndexedDB 缓存命中时，0ms 延迟显示
2. **懒加载缓存**: 首次从 R2 加载后自动缓存
3. **后台同步**: 不阻塞 UI，后台静默下载

### 存储限制

- IndexedDB: 约 50MB - 2GB (取决于浏览器)
- R2: 无限制 (按使用量计费)

### 清理策略

可在 `useLocalImageCache` 中实现 LRU 清理：
- 超过存储阈值时，删除最旧的缓存
- 用户手动清理选项

## 错误处理

| 场景 | 处理方式 |
|------|----------|
| R2 上传失败 | 记录日志，图片仍可通过原 URL 显示 |
| 本地缓存失败 | 静默失败，下次重新缓存 |
| 同步中断 | 保存进度，下次继续 |
| R2 图片不存在 | 回退到原始 URL |

## 未来扩展

- [ ] 图片压缩 (上传前/显示时)
- [ ] 缓存预热 (预加载可能查看的图片)
- [ ] 离线模式 (完全离线查看已缓存图片)
- [ ] 存储空间管理 UI
- [ ] 选择性同步 (仅同步收藏/最近)
